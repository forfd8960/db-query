# Data Model: Query Results Export

**Feature**: Query Results Export  
**Phase**: Phase 1 - Design  
**Date**: 2025-12-27

## Overview

This feature extends the existing query execution flow with export capabilities. The data model focuses on the request/response structures for export operations and the internal representation of export formats.

## Core Entities

### 1. ExportFormat (Enum)

Represents the supported export file formats.

**Attributes**:
- `CSV`: Comma-separated values format
- `JSON`: JavaScript Object Notation format
- `EXCEL`: Microsoft Excel XLSX format

**Validation Rules**:
- Must be one of the three defined values
- Case-insensitive when received from API (normalized to uppercase)

**State Transitions**: N/A (immutable enum)

**Relationships**: Used by ExportRequest

---

### 2. ExportRequest (Input Model)

Represents a user's request to export query results.

**Attributes**:
- `format` (ExportFormat, required): The desired export format
- `dbName` (string, derived from URL path): Database name for filename generation
- `queryResults` (QueryResult, transient): The query results to export (from previous query execution)

**Validation Rules**:
- `format` must be valid ExportFormat enum value
- `dbName` must be non-empty string
- `queryResults` must contain valid data (columns and rows arrays)
- Row count must not exceed 100,000 (MAX_EXPORT_ROWS)

**Relationships**:
- References `QueryResult` entity (existing model from query execution)
- Used by export service to generate exports

---

### 3. ExportMetadata (Internal Model)

Represents metadata for the export operation (used internally, not in API).

**Attributes**:
- `filename` (string): Generated filename (e.g., "mydb_2025-12-27_143022.csv")
- `mimeType` (string): MIME type for HTTP response
- `contentDisposition` (string): Content-Disposition header value
- `timestamp` (datetime): Export generation timestamp

**Validation Rules**:
- `filename` must be sanitized (no special characters)
- `filename` length must not exceed 200 characters
- `mimeType` must be valid MIME type for the format
- `timestamp` must be current server time

**Relationships**: Generated by export service based on ExportRequest

---

### 4. QueryResult (Existing Entity - Referenced)

Existing model from query execution, used as input to export operations.

**Attributes** (relevant to export):
- `columns` (list[string]): Column names from query
- `rows` (list[dict[string, Any]]): Result rows as dictionaries
- `rowCount` (int): Number of rows returned
- `executionTime` (float): Query execution time in milliseconds

**Usage in Export**:
- `columns` used for CSV headers, JSON object keys, Excel column headers
- `rows` provide the data to export
- `rowCount` used for validation (max 100,000 rows)

---

## Data Type Mappings

### Python → CSV Mapping

| Python Type | CSV Representation | Notes |
|-------------|-------------------|-------|
| `str` | Escaped string | Quotes added if contains comma/quote/newline |
| `int`, `float` | Numeric string | No quotes |
| `None` | Empty string | Empty field (not "None" or "null") |
| `bool` | "True" / "False" | String representation |
| `datetime`, `date` | ISO 8601 string | e.g., "2025-12-27T14:30:00" |
| Other objects | `str(value)` | Fallback to string representation |

### Python → JSON Mapping

| Python Type | JSON Type | Notes |
|-------------|-----------|-------|
| `str` | string | UTF-8 encoded |
| `int`, `float` | number | Native JSON number type |
| `None` | null | JSON null (not string) |
| `bool` | boolean | true/false (lowercase) |
| `datetime`, `date` | string | ISO 8601 format via `.isoformat()` |
| `dict`, `list` | object/array | Nested structures preserved |
| Other objects | string | Fallback via `default=str` |

### Python → Excel Mapping

| Python Type | Excel Cell Type | Number Format | Notes |
|-------------|----------------|---------------|-------|
| `str` | Text | General | Default text formatting |
| `int`, `float` | Number | General | No thousands separator |
| `None` | Empty | - | Empty cell (not text "None") |
| `bool` | Boolean | - | TRUE/FALSE |
| `datetime` | Date | yyyy-mm-dd hh:mm:ss | Excel date serial number |
| `date` | Date | yyyy-mm-dd | Excel date serial number |
| Other objects | Text | General | Converted to string |

---

## File Format Specifications

### CSV Format

**Structure**:
```csv
column1,column2,column3
value1,value2,value3
value4,value5,value6
```

**Encoding**: UTF-8 with BOM (for Excel compatibility)

**Delimiter**: Comma (`,`)

**Quote Character**: Double quote (`"`)

**Quoting Strategy**: `csv.QUOTE_MINIMAL` (only when necessary)

**Line Terminator**: `\r\n` (Windows-style for Excel compatibility)

**Header Row**: Always included as first row

---

### JSON Format

**Structure**:
```json
[
  {
    "column1": "value1",
    "column2": 123,
    "column3": null
  },
  {
    "column1": "value2",
    "column2": 456,
    "column3": "2025-12-27T14:30:00"
  }
]
```

**Encoding**: UTF-8 (no BOM)

**Indentation**: 2 spaces (for readability)

**Key Order**: Preserves column order from query results

**Special Values**:
- Null values: `null` (not `"null"`)
- Numbers: Unquoted (e.g., `123`, `45.67`)
- Booleans: `true`/`false` (lowercase)
- Dates: ISO 8601 strings (e.g., `"2025-12-27T14:30:00"`)

**Array Wrapping**: Always wrap rows in top-level array

---

### Excel Format (XLSX)

**Structure**:
- Single worksheet named "Query Results"
- Column headers in row 1 (bold formatting optional)
- Data starts from row 2
- Column width auto-sized (optional enhancement)

**Encoding**: Binary XLSX format (OpenXML)

**Data Types**: Native Excel types (number, text, date, boolean, empty)

**Formatting**:
- Headers: Optional bold formatting
- Numbers: Right-aligned (Excel default)
- Text: Left-aligned (Excel default)
- Dates: Excel date format with custom number format

**Limits**: Excel 2007+ (1,048,576 rows × 16,384 columns) - far exceeds our 100,000 row limit

---

## API Data Flow

### Export Request Flow

1. **Frontend**: User clicks export button, selects format
2. **Frontend**: Sends POST request to `/api/v1/databases/{dbName}/export`
   ```json
   {
     "format": "csv",
     "queryResults": {
       "columns": ["id", "name", "created_at"],
       "rows": [
         {"id": 1, "name": "Alice", "created_at": "2025-01-01T10:00:00"},
         {"id": 2, "name": "Bob", "created_at": "2025-01-02T11:00:00"}
       ],
       "rowCount": 2,
       "executionTime": 45.2
     }
   }
   ```
3. **Backend**: Validates request (format valid, row count ≤ 100,000)
4. **Backend**: Generates export file in memory
5. **Backend**: Streams file to client with appropriate headers
6. **Frontend**: Browser initiates download

### Alternative Flow (Simpler)

Instead of POST with queryResults in body, we can store last query result in frontend state and send only format:

1. **Frontend**: Maintains current query results in state
2. **Frontend**: On export click, takes current results + selected format
3. **Frontend**: Generates download locally OR sends to backend

**Recommendation**: Backend generation (for consistency and future server-side features like email delivery)

---

## Column Name Disambiguation

### Problem
SQL allows duplicate column names in SELECT results:
```sql
SELECT id, name, id FROM users
```

### Solution
Append numeric suffixes to duplicates:

**Input Columns**: `["id", "name", "id"]`  
**Output Columns**: `["id", "name", "id_1"]`

**Input Columns**: `["value", "value", "value"]`  
**Output Columns**: `["value", "value_1", "value_2"]`

**Algorithm**:
```python
def disambiguate_columns(columns: list[str]) -> list[str]:
    seen: dict[str, int] = {}
    result: list[str] = []
    
    for col in columns:
        if col in seen:
            seen[col] += 1
            result.append(f"{col}_{seen[col]}")
        else:
            seen[col] = 0
            result.append(col)
    
    return result
```

---

## Filename Generation

### Format
`{sanitized_db_name}_{timestamp}.{extension}`

### Examples
- `myapp_db_2025-12-27_143022.csv`
- `production_2025-12-27_143022.json`
- `analytics_2025-12-27_143022.xlsx`

### Sanitization Rules

**Unsafe Characters** (replaced with underscore):
- Path separators: `/`, `\`
- Special characters: `:`, `*`, `?`, `"`, `<`, `>`, `|`
- Whitespace: spaces replaced with `_`

**Length Limit**: 200 characters (including extension)

**Timestamp Format**: `YYYY-MM-DD_HHMMSS` (sortable, human-readable)

**Extension Mapping**:
- CSV → `.csv`
- JSON → `.json`
- EXCEL → `.xlsx`

---

## Error States

### ExportTooLargeError

**Condition**: Row count exceeds 100,000  
**HTTP Status**: 400 Bad Request  
**Response**:
```json
{
  "error": {
    "code": "EXPORT_TOO_LARGE",
    "message": "Export limited to 100,000 rows. Your query returned 250,000 rows. Please add a LIMIT clause to your query.",
    "details": {
      "maxRows": 100000,
      "actualRows": 250000
    }
  }
}
```

### InvalidFormatError

**Condition**: Format parameter not in [CSV, JSON, EXCEL]  
**HTTP Status**: 400 Bad Request  
**Response**:
```json
{
  "error": {
    "code": "INVALID_FORMAT",
    "message": "Invalid export format 'pdf'. Supported formats: csv, json, excel",
    "details": {
      "providedFormat": "pdf",
      "supportedFormats": ["csv", "json", "excel"]
    }
  }
}
```

### ExportGenerationError

**Condition**: Unexpected error during file generation  
**HTTP Status**: 500 Internal Server Error  
**Response**:
```json
{
  "error": {
    "code": "EXPORT_GENERATION_FAILED",
    "message": "Failed to generate export file. Please try again.",
    "details": {
      "format": "excel",
      "errorType": "MemoryError"
    }
  }
}
```

---

## Validation Rules Summary

### Request Validation
- ✅ Format must be valid enum value (CSV, JSON, EXCEL)
- ✅ Database name must be non-empty
- ✅ Query results must be present
- ✅ Row count must be ≤ 100,000

### Data Validation
- ✅ Column names must be non-empty strings
- ✅ Duplicate column names are disambiguated
- ✅ Null values preserved correctly for each format
- ✅ Data types mapped appropriately for each format

### Output Validation
- ✅ Filename sanitized and length-limited
- ✅ MIME type matches format
- ✅ Encoding is UTF-8 (or UTF-8 BOM for CSV)
- ✅ File structure conforms to format specification

---

## Future Enhancements (Out of Scope)

- Custom column selection (export only specific columns)
- Row filtering (export subset of displayed rows)
- Custom filename prefix/suffix
- Email delivery option
- Scheduled/recurring exports
- Export history tracking
- Compression (gzip) for large files
- Additional formats (XML, Parquet, etc.)
